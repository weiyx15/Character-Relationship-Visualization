<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="js_css/bootstrap.min.css">
<script src="js_css/jquery.min.js"></script>
<script src="js_css/bootstrap.min.js"></script>
<style>

.links line {
  /* stroke: #999; */
  stroke-opacity: 0.6;
}

.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

text {
    font-family: sans-serif;
    font-size: 10px;
}
</style>
<body>
<div class="panel panel-success" style="position:absolute; left:850px; top:40px; width:400px">
    <div class="panel-heading">
        <h3 class="panel-title">节点详细信息</h3>
    </div>
    <div class="panel-body">
        <p id="point_info" style="font-size: 15px;background: rgba(235, 232, 232, 0.548);border-radius: 10px;margin-bottom: 0px;padding-top: 5px;padding-bottom: 5px;padding-right: 5px;border-left-width: 5px;padding-left: 10px;margin-top: 15px;"></p>
        <!--<div class = "row pre-scrollable" style="margin:0px;">-->
            <p  class="pre-scrollable" id="dialog_info" style="font-size: 15px;background: rgba(235, 232, 232, 0.548);border-radius: 10px;margin-bottom: 0px;padding-top: 5px;padding-bottom: 5px;padding-right: 5px;border-left-width: 5px;padding-left: 10px;margin-top: 15px;"></p>
        <!--</div>-->
    </div>
</div>

    <svg width="960" height="600"></svg>
    <!-- <script src="https://d3js.org/d3.v4.min.js"></script> -->
    <script src="d3.v4.min.js"></script>
    <script>

    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var nodeColor = d3.scaleOrdinal(d3.schemeCategory20);

    var edgeColor = d3.scaleOrdinal(d3.schemeCategory10);

    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function(d) { return d.id; }))
        .force("charge", d3.forceManyBody().strength(-200))
        .force("center", d3.forceCenter(width / 2, height / 2));

    d3.json("jsons/10tings_dialogs_scenes_all_LPA.json", function(error, graph) {
      if (error) throw error;

      var link = svg.append("g")
          .attr("class", "links")
        .selectAll("line")
        .data(graph.all.links)
        .enter().append("line")
          .attr("stroke", function(d) { return edgeColor(d.value); })
          .attr("stroke-width", function(d) { return Math.sqrt(d.value); })
                .style("opacity", 1);


      var node = svg.append("g")
          .attr("class", "nodes")
        .selectAll("g")
        .data(graph.all.nodes)
        .enter().append("g");

      var circles = node.append("circle")
          .attr("r", function(d) { return 4 * Math.pow(d.group, 0.3); })
          .attr("fill", function(d) { return nodeColor(d.cluster); })
          .call(d3.drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended));
      circles.on("mouseover",function(d){
          circles.style("opacity", 0.2);
          d3.select(this)
              .style("opacity", 1.0);

          var attention_name = d.id;

          link.style("opacity", 0.2);

          adjacent_nodes = new Map();   // adj_node_id -> dialogs_between_attention_node_and_adj_node

          d3.select("body").selectAll("line").data(graph.all.links).style("opacity", function (d2) {
              if(d2.target.id == attention_name || d2.source.id == attention_name){
                if (d2.target.id != attention_name) {
                  adjacent_nodes.set(d2.target.id, d2.dialogs);
                }
                if (d2.source.id != attention_name) {
                  adjacent_nodes.set(d2.source.id, d2.dialogs);
                }
                return 1.0;
              }else{
                return 0.2;
              }
          });
      });
      circles.on("click",function(d){
          var attentioned_dialogs = "";

          adjacent_nodes.forEach((value, key, map) => {
            attentioned_dialogs += 'said to &nbsp<b>' + key+ '</b>:&nbsp' + value[0] +'<br>';
          });

          var p_dialog_info = document.getElementById('dialog_info');
          p_dialog_info.innerHTML = attentioned_dialogs;

          var point_info = document.getElementById('point_info');
          var attentioned_point_info = '';
          attentioned_point_info += '<b>人物姓名</b>:&nbsp' + d.id + '<br>';
          attentioned_point_info += '<b>角色重要程度</b>:&nbsp' + d.group + '<br>';
          attentioned_point_info += '<b>相关人物</b>:';

          index = 0;
          adjacent_nodes.forEach((value, key, map) => {
              if(index %4 == 0)
                  attentioned_point_info += '<br>';
              attentioned_point_info += key + "&nbsp";
              index ++;
          });
          attentioned_point_info += '<br>';
          point_info.innerHTML = attentioned_point_info;
      });

      circles.on("mouseout",function(d) {
          circles.style("opacity", 1.0);
          link.style("opacity", 1.0);
//          var p_dialog_info = document.getElementById('dialog_info');
//          p_dialog_info.innerHTML = '';
//          var p_point_info = document.getElementById('point_info');
//          p_point_info.innerHTML = '';
      });

      var lables = node.append("text")
          .text(function(d) {
            return d.id;
          })
          .attr('x', 6)
          .attr('y', 3);

      node.append("title")
          .text(function(d) { return d.id; });

      simulation
          .nodes(graph.all.nodes)
          .on("tick", ticked);

      simulation.force("link")
          .links(graph.all.links);

      function ticked() {
        link
            .attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        node
            .attr("transform", function(d) {
              return "translate(" + d.x + "," + d.y + ")";
            })
      }
    });

    function dragstarted(d) {
      if (!d3.event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function dragended(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

    </script>
</body>